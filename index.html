<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Smart FEED ST-FO-820</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="stylelogin.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Prompt&display=swap" rel="stylesheet">
</head>

<body>

  <div class="container">
    <div class="glass-box fade" id="loginBox">
      <h2>Smart FEED ST-FO-820</h2>
      <input type="text" id="loginUser" placeholder="Enter your username">
      <select id="loginBranch" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px;">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
         <option value="BKF">BKF</option>
        <option value="BPF">BPF</option>
        <option value="KBF">KBF</option>
        <option value="KKF">KKF</option>
        <option value="KRF">KRF</option>
        <option value="KTF">KTF</option>
        <option value="LPF">LPF</option>
        <option value="PLF">PLF</option>
        <option value="PTF">PTF</option>
        <option value="RBF">RBF</option>
        <option value="SKF">SKF</option>
        <option value="SRF">SRF</option>
        <option value="TRF">TRF</option>
      </select>
      <button onclick="handleLogin()">Login</button>
      <div class="link">
        <a href="#" onclick="showBox('registerBox')">Register</a>
      </div>
    </div>

    <div class="glass-box hidden fade" id="registerBox">
      <h2>üìò Register</h2>
      <input type="text" id="regUser" placeholder="Username">
      <input type="email" id="regEmail" placeholder="Email">
      <select id="regBranch" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px;">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
        <option value="BKF">BKF</option>
        <option value="BPF">BPF</option>
        <option value="KBF">KBF</option>
        <option value="KKF">KKF</option>
        <option value="KRF">KRF</option>
        <option value="KTF">KTF</option>
        <option value="LPF">LPF</option>
        <option value="PLF">PLF</option>
        <option value="PTF">PTF</option>
        <option value="RBF">RBF</option>
        <option value="SKF">SKF</option>
        <option value="SRF">SRF</option>
        <option value="TRF">TRF</option>
      </select>
      <select id="regPermission" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px;">
        <option value="User" selected>üë§ User</option>
        <option value="Admin"> üßë‚ÄçüíªAdmin</option>
        <option value="AV/AVP"> üéñÔ∏èVP/AVP</option>
      </select>
      <button onclick="handleRegister()">Register</button>

      <div class="link">
        <a href="#" onclick="showBox('loginBox')">‚Üê Back to Login</a>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Loader ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏î‡πâ‡∏ß‡∏¢ flex ‡∏Ç‡∏≠‡∏á container -->
  <div id="loaderOverlay" class="hidden">
    <div class="loader-box">
      <div class="progress-text" id="progressText">0%</div>
      <div class="progress-circle"></div>
    </div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzs6KoJyWaRc8NrikwRUwYOHx4yTpEbXSiinLVYsF6zAPYuPMd__bA8Yr-KtHDX2kde/exec";

    function showBox(boxId) {
      document.querySelectorAll('.glass-box').forEach(box => {
        box.classList.add('hidden');
      });
      document.getElementById(boxId).classList.remove('hidden');
    }

    function handleLogin() {
      const username = document.getElementById('loginUser').value.trim();
      const branch = document.getElementById('loginBranch').value;

      if (!username || !branch) {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å username ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤");
        return;
      }

      // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡∏ï progress ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á
      document.getElementById("progressText").textContent = "0%";
      document.getElementById("loaderOverlay").classList.remove("hidden");

      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.floor(Math.random() * 5) + 1;
        if (progress > 100) progress = 100;
        document.getElementById("progressText").textContent = progress + "%";

        if (progress >= 100) {
          clearInterval(interval);

          // ‚úÖ ‡∏ó‡∏≥ Login fetch
          fetch(scriptURL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `mode=loginOnly&username=${encodeURIComponent(username)}&branch=${encodeURIComponent(branch)}`
          })
            .then(res => {
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Response ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (HTTP 200 OK)
              if (!res.ok) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
                return res.text().then(text => { throw new Error(text) });
              }
              // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô .json() ‡πÄ‡∏û‡∏∑‡πà‡∏≠ parse response ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô JSON
              return res.json();
            })
            .then(data => {
              console.log("Response from server:", data); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Parse ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Console

              // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö status ‡∏à‡∏≤‡∏Å JSON ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
              if (data.status === "success") {
                // ‡∏´‡∏≤‡∏Å Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                localStorage.setItem("username", username);
                localStorage.setItem("branch", branch);
                localStorage.setItem("permission", data.permission || "-"); // ‡∏î‡∏∂‡∏á permission ‡∏à‡∏≤‡∏Å data object

                alert("‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
                window.location.href = "Home.html"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Home.html
              } else {
                // ‡∏´‡∏≤‡∏Å Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà Apps Script ‡∏™‡πà‡∏á‡∏°‡∏≤
                alert("‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
                document.getElementById("loaderOverlay").classList.add("hidden");
              }
            })
            .catch(error => {
              console.error("Error during login fetch:", error);
              alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error.message);
              document.getElementById("loaderOverlay").classList.add("hidden");
            });
        }
      }, 35);
    }

    function handleRegister() {
      const username = document.getElementById('regUser').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const branch = document.getElementById('regBranch').value;
      const permission = document.getElementById('regPermission').value;

      if (!username || !email || !branch || !permission) {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username, Email ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤");
        return;
      }
      console.log("üöÄ Permission:", permission);
      fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `mode=register&username=${encodeURIComponent(username)}&email=${encodeURIComponent(email)}&branch=${encodeURIComponent(branch)}&permission=${encodeURIComponent(permission)}`
      })
        .then(res => {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Response ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (HTTP 200 OK)
          if (!res.ok) {
            return res.text().then(text => { throw new Error(text) });
          }
          // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô .json() ‡πÄ‡∏û‡∏∑‡πà‡∏≠ parse response ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô JSON
          return res.json();
        })
        .then(data => {
          console.log("Response from server:", data); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Parse ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Console

          // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö status ‡∏à‡∏≤‡∏Å JSON ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
          if (data.status === "success") {
            alert("‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
            showBox('loginBox'); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
          } else {
            alert("‚ùå ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
          }
        })
        .catch(err => {
          console.error("Error during registration fetch:", err);
          alert("‚ùå Error: " + err.message);
        });
    }
  </script>

</body>
